<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#2563eb" />
  <title>Painel Administrativo - Zen Marmitas</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üç±</text></svg>">
  
  <!-- CSS para interface robusta -->
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f8fafc;
      color: #1e293b;
      line-height: 1.6;
    }
    
    #nc-root { 
      min-height: 100vh; 
      position: relative;
    }
    
    /* Loading State */
    .cms-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 10px;
    }
    
    .loading-subtitle {
      font-size: 14px;
      opacity: 0.8;
    }
    
    /* Error State */
    .cms-error {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fee2e2;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 20px;
    }
    
    .error-icon {
      font-size: 64px;
      margin-bottom: 20px;
      color: #dc2626;
    }
    
    .error-title {
      font-size: 24px;
      font-weight: 600;
      color: #dc2626;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .error-message {
      font-size: 16px;
      color: #7f1d1d;
      text-align: center;
      max-width: 500px;
      margin-bottom: 20px;
    }
    
    .retry-button {
      background: #dc2626;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .retry-button:hover {
      background: #b91c1c;
    }
    
    /* Success State */
    .cms-success {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 500;
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Hidden state */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Loading State -->
  <div id="loading-state" class="cms-loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">Carregando Painel Administrativo</div>
    <div class="loading-subtitle">Zen Marmitas</div>
  </div>
  
  <!-- Error State -->
  <div id="error-state" class="cms-error hidden">
    <div class="error-icon">‚ö†Ô∏è</div>
    <div class="error-title">Erro ao Carregar o CMS</div>
    <div id="error-message" class="error-message">
      Ocorreu um erro inesperado ao inicializar o sistema administrativo.
    </div>
    <button id="retry-button" class="retry-button" onclick="retryCMSInit()">
      Tentar Novamente
    </button>
  </div>
  
  <!-- Success State -->
  <div id="success-state" class="cms-success hidden">
    ‚úÖ CMS inicializado com sucesso!
  </div>
  
  <!-- CMS Root -->
  <div id="nc-root"></div>
  
  <!-- Scripts -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js" 
          onerror="handleScriptError('Erro ao carregar o script do Decap CMS')"></script>
  <script src="./script.js"></script>
  
  <script>
    // Configura√ß√µes globais
    const CMS_CONFIG = {
      maxRetries: 3,
      retryDelay: 2000,
      timeout: 30000,
      version: '^3.0.0'
    };
    
    let retryCount = 0;
    let initTimeout;
    
    // Elementos DOM
    const elements = {
      loading: document.getElementById('loading-state'),
      error: document.getElementById('error-state'),
      success: document.getElementById('success-state'),
      errorMessage: document.getElementById('error-message'),
      retryButton: document.getElementById('retry-button'),
      root: document.getElementById('nc-root')
    };
    
    // Fun√ß√µes utilit√°rias
    const utils = {
      showElement: (element) => {
        element.classList.remove('hidden');
      },
      
      hideElement: (element) => {
        element.classList.add('hidden');
      },
      
      showSuccess: (message = '‚úÖ CMS inicializado com sucesso!') => {
        elements.success.textContent = message;
        utils.showElement(elements.success);
        setTimeout(() => {
          utils.hideElement(elements.success);
        }, 3000);
      },
      
      showError: (message) => {
        elements.errorMessage.textContent = message;
        utils.hideElement(elements.loading);
        utils.showElement(elements.error);
      },
      
      showLoading: () => {
        utils.hideElement(elements.error);
        utils.showElement(elements.loading);
      },
      
      validateCMS: () => {
        if (typeof CMS === 'undefined') {
          throw new Error('CMS n√£o foi carregado corretamente');
        }
        
        if (typeof CMS.init !== 'function') {
          throw new Error('M√©todo CMS.init n√£o est√° dispon√≠vel');
        }
        
        return true;
      },
      
      checkNetworkConnection: () => {
        if (!navigator.onLine) {
          throw new Error('Sem conex√£o com a internet');
        }
      }
    };
    
     // Estado para evitar m√∫ltiplas inicializa√ß√µes
     let cmsInitialized = false;
     let cmsInitializationInProgress = false;
     
     // Fun√ß√£o principal de inicializa√ß√£o
     async function initializeCMS() {
       if (cmsInitialized || cmsInitializationInProgress) {
         console.log('‚ö†Ô∏è CMS j√° inicializado ou em progresso, pulando...');
         return;
       }
       
       try {
         cmsInitializationInProgress = true;
         utils.showLoading();
         retryCount++;
         
         // Verificar conex√£o
         utils.checkNetworkConnection();
         
         // Aguardar um pouco para garantir que o script foi carregado
         await new Promise(resolve => setTimeout(resolve, 1000));
         
         // Validar CMS
         utils.validateCMS();
         
         // Configurar timeout
         initTimeout = setTimeout(() => {
           throw new Error('Timeout: CMS demorou muito para inicializar');
         }, CMS_CONFIG.timeout);
         
         // Inicializar CMS
         console.log('Inicializando CMS...');
         CMS.init();
         
         // Limpar timeout
         clearTimeout(initTimeout);
         
         // Sucesso
         utils.hideElement(elements.loading);
         utils.showSuccess();
         
         console.log('‚úÖ CMS inicializado com sucesso!');
         cmsInitialized = true;
         cmsInitializationInProgress = false;
         
         // Resetar contador de tentativas
         retryCount = 0;
         
       } catch (error) {
         console.error('‚ùå Erro ao inicializar CMS:', error);
         cmsInitializationInProgress = false;
         
         // Limpar timeout se existir
         if (initTimeout) {
           clearTimeout(initTimeout);
         }
         
         // Verificar se deve tentar novamente
         if (retryCount < CMS_CONFIG.maxRetries) {
           console.log(`Tentativa ${retryCount} de ${CMS_CONFIG.maxRetries}`);
           setTimeout(initializeCMS, CMS_CONFIG.retryDelay);
         } else {
           utils.showError(error.message || 'Erro desconhecido ao inicializar o CMS');
         }
       }
     }
    
     // Fun√ß√£o para tentar novamente
     function retryCMSInit() {
       retryCount = 0;
       cmsInitialized = false;
       cmsInitializationInProgress = false;
       initializeCMS();
     }
    
    // Tratamento de erros de script
    function handleScriptError(message) {
      console.error('‚ùå Erro no script:', message);
      utils.showError(`${message}. Verifique sua conex√£o com a internet.`);
    }
    
    // Tratamento de erros globais
    window.addEventListener('error', (event) => {
      console.error('‚ùå Erro global:', event.error);
      if (event.error && event.error.message.includes('CMS')) {
        utils.showError(`Erro no CMS: ${event.error.message}`);
      }
    });
    
    // Tratamento de erros de promise
    window.addEventListener('unhandledrejection', (event) => {
      console.error('‚ùå Promise rejeitada:', event.reason);
      if (event.reason && event.reason.message && event.reason.message.includes('CMS')) {
        utils.showError(`Erro na Promise: ${event.reason.message}`);
      }
    });
    
    // Verificar se o script foi carregado
    function checkScriptLoaded() {
      if (typeof CMS !== 'undefined') {
        console.log('‚úÖ Script do CMS carregado com sucesso');
        initializeCMS();
      } else {
        console.log('‚è≥ Aguardando carregamento do script...');
        setTimeout(checkScriptLoaded, 500);
      }
    }
    
    // Inicializar quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Iniciando aplica√ß√£o CMS...');
      checkScriptLoaded();
    });
    
    // Fallback caso o DOMContentLoaded j√° tenha disparado
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkScriptLoaded);
    } else {
      checkScriptLoaded();
    }
    
    // Expor fun√ß√£o para retry global
    window.retryCMSInit = retryCMSInit;
  </script>
</body>
</html>